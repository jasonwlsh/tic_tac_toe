<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>112511188 甯宇誠 Lab3 Tic Tac Toe</title>
    <style>
        body {
            margin: 0;
            padding-top: 20px;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        h2 {
            margin: 5px 0 10px 0;
            font-size: 16px;
            color: #444;
        }
        #status {
            margin-top: 5px;
            font-size: 14px;
            color: #333;
            font-weight: bold;
            height: 20px; /* 固定高度避免文字跳動 */
        }
        /* 新增按鈕樣式 */
        #restart-btn {
            margin-top: 15px;
            padding: 10px 25px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* 預設隱藏 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #restart-btn:hover {
            background-color: #0b7dda;
        }

        #board {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 3px;
            background-color: #d0d0d0;
            padding: 5px;
            border: 3px solid #888;
        }
        .cell {
            width: 80px;
            height: 80px;
            font-size: 40px;
            font-weight: bold;
            text-align: center;
            line-height: 80px;
            background-color: #e0e0e0;
            border: 2px solid #888;
            cursor: pointer;
            user-select: none;
        }
        .cell.disabled {
            cursor: default;
        }
        .cell.win {
            background-color: cyan;
            transition: background-color 0.3s;
        }
        .cell.tie {
            background-color: lightcoral;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body>

<h1>112511188 甯宇誠 - Lab3 Tic Tac Toe</h1>
<h2>Mode: Play with Computer (Minimax AI)</h2>
<div id="status">Player X (You) turn</div>

<button id="restart-btn" onclick="resetGame()">Play Again</button>

<div id="board">
    <div class="cell" id="cell-0-0" onclick="handleClick(0,0)"></div>
    <div class="cell" id="cell-0-1" onclick="handleClick(0,1)"></div>
    <div class="cell" id="cell-0-2" onclick="handleClick(0,2)"></div>

    <div class="cell" id="cell-1-0" onclick="handleClick(1,0)"></div>
    <div class="cell" id="cell-1-1" onclick="handleClick(1,1)"></div>
    <div class="cell" id="cell-1-2" onclick="handleClick(1,2)"></div>

    <div class="cell" id="cell-2-0" onclick="handleClick(2,0)"></div>
    <div class="cell" id="cell-2-1" onclick="handleClick(2,1)"></div>
    <div class="cell" id="cell-2-2" onclick="handleClick(2,2)"></div>
</div>

<script>
    const HUMAN = "X";
    const AI = "O";

    let currentPlayer = HUMAN;
    let gameOver = false;

    let board = [
        [null, null, null],
        [null, null, null],
        [null, null, null]
    ];

    function getCell(row, col) {
        return document.getElementById(`cell-${row}-${col}`);
    }

    function setStatus(text) {
        document.getElementById("status").textContent = text;
    }

    function handleClick(row, col) {
        if (gameOver) return;
        if (currentPlayer !== HUMAN) return;
        if (board[row][col] !== null) return;

        board[row][col] = HUMAN;
        const cell = getCell(row, col);
        cell.textContent = HUMAN;
        cell.classList.add("disabled");

        // 依然保留一個極短的延遲，確保 UI 渲染順暢
        setTimeout(() => {
            const result = checkWinner();
            if (result.winner !== null) {
                declareWinner(result.winner, result.paths);
            } else {
                currentPlayer = AI;
                setStatus("Computer (O) thinking...");
                setTimeout(computerMove, 200);
            }
        }, 10);
    }

    function checkWinner() {
        let winningPaths = [];

        // Check Rows
        for (let r = 0; r < 3; r++) {
            if (board[r][0] && board[r][0] === board[r][1] && board[r][1] === board[r][2]) {
                winningPaths.push([[r,0], [r,1], [r,2]]);
            }
        }

        // Check Columns
        for (let c = 0; c < 3; c++) {
            if (board[0][c] && board[0][c] === board[1][c] && board[1][c] === board[2][c]) {
                winningPaths.push([[0,c], [1,c], [2,c]]);
            }
        }

        // Check Diagonals
        if (board[0][0] && board[0][0] === board[1][1] && board[1][1] === board[2][2]) {
            winningPaths.push([[0,0], [1,1], [2,2]]);
        }
        if (board[0][2] && board[0][2] === board[1][1] && board[1][1] === board[2][0]) {
            winningPaths.push([[0,2], [1,1], [2,0]]);
        }

        if (winningPaths.length > 0) {
            const [firstR, firstC] = winningPaths[0][0];
            const winner = board[firstR][firstC];
            return { winner: winner, paths: winningPaths };
        }

        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                if (board[r][c] === null) {
                    return { winner: null, paths: [] };
                }
            }
        }

        return { winner: "tie", paths: [] };
    }

    // === 修改重點：改用按鈕控制 ===
    function declareWinner(winner, paths) {
        gameOver = true;
        let message = "";

        if (winner === "tie") {
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    const cell = getCell(r, c);
                    cell.classList.add("tie", "disabled");
                }
            }
            message = "It's a tie!";
        } else {
            paths.forEach(path => {
                path.forEach(([r, c]) => {
                    const cell = getCell(r, c);
                    cell.classList.add("win");
                });
            });
            message = `Player ${winner} wins!`;
        }
        
        setStatus(message);
        disableAll(); // 確保剩下的格子不能點
        
        // 顯示重新開始按鈕
        document.getElementById("restart-btn").style.display = "block";
    }

    function resetGame() {
        board = [
            [null, null, null],
            [null, null, null],
            [null, null, null]
        ];
        currentPlayer = HUMAN;
        gameOver = false;
        setStatus("Player X (You) turn");
        
        // 隱藏按鈕
        document.getElementById("restart-btn").style.display = "none";

        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const cell = getCell(r, c);
                cell.textContent = "";
                cell.className = "cell"; 
            }
        }
    }

    function disableAll() {
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                const cell = getCell(r, c);
                cell.classList.add("disabled");
            }
        }
    }

    // -------- Minimax AI --------
    // (AI 部分程式碼完全沒變，但為了完整性保留在此)

    function isMovesLeft() {
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                if (board[r][c] === null) return true;
            }
        }
        return false;
    }

    function evaluateBoard() {
        for (let r = 0; r < 3; r++) {
            if (board[r][0] && board[r][0] === board[r][1] && board[r][1] === board[r][2]) {
                if (board[r][0] === AI) return 10;
                if (board[r][0] === HUMAN) return -10;
            }
        }
        for (let c = 0; c < 3; c++) {
            if (board[0][c] && board[0][c] === board[1][c] && board[1][c] === board[2][c]) {
                if (board[0][c] === AI) return 10;
                if (board[0][c] === HUMAN) return -10;
            }
        }
        if (board[0][0] && board[0][0] === board[1][1] && board[1][1] === board[2][2]) {
            if (board[0][0] === AI) return 10;
            if (board[0][0] === HUMAN) return -10;
        }
        if (board[0][2] && board[0][2] === board[1][1] && board[1][1] === board[2][0]) {
            if (board[0][2] === AI) return 10;
            if (board[0][2] === HUMAN) return -10;
        }
        return 0;
    }

    function minimax(depth, isMax) {
        const score = evaluateBoard();

        if (score === 10) return score - depth;
        if (score === -10) return score + depth;

        if (!isMovesLeft()) return 0;

        if (isMax) {
            let best = -Infinity;
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    if (board[r][c] === null) {
                        board[r][c] = AI;
                        best = Math.max(best, minimax(depth + 1, false));
                        board[r][c] = null;
                    }
                }
            }
            return best;
        } else {
            let best = Infinity;
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    if (board[r][c] === null) {
                        board[r][c] = HUMAN;
                        best = Math.min(best, minimax(depth + 1, true));
                        board[r][c] = null;
                    }
                }
            }
            return best;
        }
    }

    function findBestMove() {
        let bestVal = -Infinity;
        let bestMove = { row: -1, col: -1 };

        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 3; c++) {
                if (board[r][c] === null) {
                    board[r][c] = AI;
                    const moveVal = minimax(0, false);
                    board[r][c] = null;
                    if (moveVal > bestVal) {
                        bestVal = moveVal;
                        bestMove = { row: r, col: c };
                    }
                }
            }
        }
        return bestMove;
    }

    function computerMove() {
        if (gameOver) return;

        const bestMove = findBestMove();
        const r = bestMove.row;
        const c = bestMove.col;
        if (r === -1 || c === -1) return;

        board[r][c] = AI;
        const cell = getCell(r, c);
        cell.textContent = AI;
        cell.classList.add("disabled");

        setTimeout(() => {
            const result = checkWinner();
            if (result.winner !== null) {
                declareWinner(result.winner, result.paths);
            } else {
                currentPlayer = HUMAN;
                setStatus("Player X (You) turn");
            }
        }, 10);
    }
</script>

</body>
</html>
